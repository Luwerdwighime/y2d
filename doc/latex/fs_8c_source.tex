\doxysection{fs.\+c}
\hypertarget{fs_8c_source}{}\label{fs_8c_source}\index{src/fs.c@{src/fs.c}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}fs.h"{}}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00003}00003\ \textcolor{keywordtype}{void}\ mkdir\_p(\textcolor{keywordtype}{char}\ *path)\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00004}00004\ \ \ \textcolor{comment}{//\ Просим\ у\ ядра\ создать\ папку}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00005}00005\ \ \ \textcolor{keywordtype}{int}\ err\ =\ mkdir(path,\ DIR\_RIGHTS);}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00007}00007\ \ \ \textcolor{comment}{//\ Анализируем\ ошибку,\ если\ err\ не\ 0,\ то\ ошибка\ не\ должна\ быть}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00008}00008\ \ \ \textcolor{comment}{//\ "{}file\ exist"{},\ иначе\ это\ нормальное\ поведение}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00009}00009\ \ \ \textcolor{keywordflow}{if}\ (err\ \&\&\ errno\ !=\ EEXIST)\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00010}00010\ \ \ \ \ perror(\textcolor{stringliteral}{"{}Ошибка\ создания\ директории:\ "{}});}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00011}00011\ \ \ \ \ perror(path);\ \textcolor{comment}{//\ Покажем\ юзеру\ путь\ ошибки}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00012}00012\ \ \ \ \ exit(1);\ \textcolor{comment}{//\ Критический\ выход,\ возвращаем\ 1}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00013}00013\ \ \ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00014}00014\ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00016}00016\ \textcolor{keywordtype}{void}\ initDirs()\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00017}00017\ \ \ mkdir\_p(VIDEO\_DIR);}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00018}00018\ \ \ mkdir\_p(AUDIO\_DIR);}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00019}00019\ \ \ mkdir\_p(DRAY\_DIR);}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00020}00020\ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00022}00022\ \textcolor{keywordtype}{char}*\ drayLogPath()\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00023}00023\ \ \ \textcolor{keywordtype}{char}\ path[BUF\_LEN];}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00024}00024\ \ \ snprintf(path,\ BUF\_LEN,\ \textcolor{stringliteral}{"{}\%s/\%s"{}},\ DRAY\_DIR,\ DRAY\_LOG);}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00025}00025\ \ \ \textcolor{keywordflow}{return}\ path;}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00026}00026\ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00028}00028\ \textcolor{keywordtype}{void}\ log\_video\_id(\textcolor{keywordtype}{char}\ *video\_id)\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00029}00029\ \ \ \textcolor{comment}{//\ Открываем\ лог}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00030}00030\ \ \ FILE\ *log\ =\ fopen(drayLogPath(),\ \textcolor{stringliteral}{"{}a"{}});}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00031}00031\ \ \ \textcolor{keywordflow}{if}\ (!log)\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00032}00032\ \ \ \ \ perror(\textcolor{stringliteral}{"{}Ошибка\ открытия\ и\ создания\ лога\ Дмитрия\ Рея"{}});}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00033}00033\ \ \ \ \ exit(2);\ \textcolor{comment}{//\ Критический\ выход,\ возвращаем\ 2}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00034}00034\ \ \ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00035}00035\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00036}00036\ \ \ fprintf(log,\ \textcolor{stringliteral}{"{}\%s\(\backslash\)n"{}},\ video\_id);\ \textcolor{comment}{//\ Пишем}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00037}00037\ \ \ fclose(log);\ \textcolor{comment}{//\ Закрываем\ лог}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00038}00038\ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00039}00039\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00040}00040\ \textcolor{keywordtype}{int}\ is\_video\_downloaded(\textcolor{keywordtype}{char}\ *video\_id)\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00041}00041\ \ \ \textcolor{comment}{//\ Открываем\ лог}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00042}00042\ \ \ FILE\ *log\ =\ fopen(drayLogPath(),\ \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00043}00043\ \ \ \textcolor{keywordflow}{if}\ (!log)\ \textcolor{keywordflow}{return}\ 0;\ \textcolor{comment}{//\ Лог\ не\ существует,\ считаем,\ что\ видео\ не\ скачано}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00045}00045\ \ \ \textcolor{keywordtype}{char}\ line[BUF\_LEN];\ \textcolor{comment}{//\ Память\ под\ строчку\ из\ лога}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00046}00046\ \ \ \textcolor{comment}{//\ Читаем\ в\ line\ построчечно,\ пока\ fgets()\ не\ вернёт\ EOF}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00047}00047\ \ \ \textcolor{keywordflow}{while}\ (fgets(line,\ BUF\_LEN,\ log))\ \{}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00048}00048\ \ \ \ \ line[strcspn(line,\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}})]\ =\ \textcolor{charliteral}{'\(\backslash\)0'};\ \textcolor{comment}{//\ Отбрасываем\ всё\ за\ первым\ \(\backslash\)n\ включительно}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00049}00049\ \ \ \ \ \textcolor{keywordflow}{if}\ (strcmp(line,\ video\_id)\ ==\ 0)\ \{\ \textcolor{comment}{//\ Нашли!}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00050}00050\ \ \ \ \ \ \ fclose(log);\ \textcolor{comment}{//\ Закрываем\ лог}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00051}00051\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 1;\ \textcolor{comment}{//\ Видео\ уже\ скачано}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00052}00052\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00053}00053\ \ \ \}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00055}00055\ \ \ fclose(log);\ \textcolor{comment}{//\ Закрываем\ лог}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00056}00056\ \ \ \textcolor{keywordflow}{return}\ 0;\ \textcolor{comment}{//\ Ни\ чего\ не\ нашли}}
\DoxyCodeLine{\Hypertarget{fs_8c_source_l00057}00057\ \}}

\end{DoxyCode}
