\doxysection{yt\+\_\+dlp.\+c}
\hypertarget{yt__dlp_8c_source}{}\label{yt__dlp_8c_source}\index{src/yt\_dlp.c@{src/yt\_dlp.c}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}yt\_dlp.h"{}}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00003}00003\ \textcolor{keywordtype}{char}*\ getOpts(\textcolor{keywordtype}{char}\ mode)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00004}00004\ \ \ \textcolor{keywordtype}{char}\ opts[BUF\_LEN];}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00005}00005\ \ \ \textcolor{keywordflow}{switch}\ (mode)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00006}00006\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'1'}:\ \textcolor{keywordflow}{return}\ MODE1;}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00007}00007\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'2'}:\ \textcolor{keywordflow}{return}\ MODE2;}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00008}00008\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'3'}:}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00009}00009\ \ \ \ \ \ \ snprintf(opts,\ BUF\_LEN,\ \textcolor{stringliteral}{"{}\%s\ \%s"{}},\ MODE1,\ MODEP);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00010}00010\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ opts;}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00011}00011\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'4'}:}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00012}00012\ \ \ \ \ \ \ snprintf(opts,\ BUF\_LEN,\ \textcolor{stringliteral}{"{}\%s\ \%s"{}},\ MODE2,\ MODEP);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00013}00013\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ opts;}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00014}00014\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'5'}:\ \textcolor{keywordflow}{return}\ MODE2;}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00015}00015\ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00016}00016\ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00018}00018\ \textcolor{keywordtype}{void}\ yt\_dlp(\textcolor{keywordtype}{char}*\ url,\ \textcolor{keywordtype}{char}\ mode)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00019}00019\ \ \ \textcolor{keywordflow}{switch}\ (mode)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00020}00020\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'1'}:\ run\_yt\_dlp(url,\ getOpts(mode),\ VIDEO\_DIR,\ FNAME);\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00021}00021\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'2'}:\ run\_yt\_dlp(url,\ getOpts(mode),\ AUDIO\_DIR,\ FNAME);\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00022}00022\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'3'}:\ run\_yt\_dlp(url,\ getOpts(mode),\ VIDEO\_DIR,\ PNAME);\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00023}00023\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'4'}:\ run\_yt\_dlp(url,\ getOpts(mode),\ AUDIO\_DIR,\ PNAME);\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00024}00024\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'5'}:\ process\_playlist\_ids(url);\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00025}00025\ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00026}00026\ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00028}00028\ \textcolor{keywordtype}{void}\ run\_yt\_dlp(\textcolor{keywordtype}{char}\ *url,\ \textcolor{keywordtype}{char}\ *opts,\ \textcolor{keywordtype}{char}\ *out\_dir,\ \textcolor{keywordtype}{char}\ *out\_tmpl)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00029}00029\ \ \ \textcolor{comment}{//\ Создаём\ команду}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00030}00030\ \ \ \textcolor{keywordtype}{char}\ cmd[BUF\_LEN];}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00031}00031\ \ \ snprintf(cmd,\ BUF\_LEN,\ YTCMD,\ opts,\ out\_dir,\ out\_tmpl,\ url);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00033}00033\ \ \ \textcolor{comment}{//\ Пробуем\ в\ цикле}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00034}00034\ \ \ \textcolor{keywordtype}{int}\ retries\ =\ RETR;}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00035}00035\ \ \ \textcolor{keywordflow}{while}\ (retries-\/-\/)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00036}00036\ \ \ \ \ \textcolor{keywordflow}{if}\ (system(cmd)\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00037}00037\ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Готово,\ файлы\ в\ \%s\(\backslash\)n"{}},\ out\_dir);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00038}00038\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00039}00039\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00040}00040\ \ \ \ \ \textcolor{comment}{//\ TODO:\ fprintf()\ в\ stderr?}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00041}00041\ \ \ \ \ printf(\textcolor{stringliteral}{"{}Ошибка\ скачивания,\ повтор\ через\ 10\ секунд.\ Попыток\ осталось:\ \%d\(\backslash\)n"{}},\ retries);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00042}00042\ \ \ \ \ sleep(10);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00043}00043\ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00044}00044\ \ \ \textcolor{comment}{//\ TODO:\ fprintf()\ в\ stderr?}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00045}00045\ \ \ printf(\textcolor{stringliteral}{"{}Не\ удалось\ скачать\ после\ \%d\ попыток\ url:\ \%s\(\backslash\)n"{}},\ RETR,\ url);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00046}00046\ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00047}00047\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00048}00048\ \textcolor{keywordtype}{void}\ process\_playlist\_ids(\textcolor{keywordtype}{char}\ *url)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00049}00049\ \ \ \textcolor{comment}{//\ Создаём\ команду}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00050}00050\ \ \ \textcolor{keywordtype}{char}\ cmd[BUF\_LEN];}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00051}00051\ \ \ snprintf(cmd,\ BUF\_LEN,\ YTIDS,\ url);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00053}00053\ \ \ \textcolor{comment}{//\ Запускаем\ команду\ и\ читаем\ её\ stdout\ построчечно}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00054}00054\ \ \ FILE\ *fp\ =\ popen(cmd,\ \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00055}00055\ \ \ \textcolor{keywordflow}{if}\ (!fp)\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00056}00056\ \ \ \ \ perror(\textcolor{stringliteral}{"{}Ошибка\ получения\ ID\ видео"{}});}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00057}00057\ \ \ \ \ exit(3);\ \textcolor{comment}{//\ Критический\ выход,\ возвращаем\ 3}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00058}00058\ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00059}00059\ \ \ \textcolor{keywordtype}{char}\ video\_id[BUF\_LEN];\ \textcolor{comment}{//\ Память\ под\ id}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00060}00060\ \ \ \textcolor{keywordflow}{while}\ (fgets(video\_id,\ BUF\_LEN,\ fp))\ \{\ \textcolor{comment}{//\ Читаем\ строки\ плейлиста}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00061}00061\ \ \ \ \ video\_id[strcspn(video\_id,\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}})]\ =\ \textcolor{charliteral}{'\(\backslash\)0'};\ \ \textcolor{comment}{//\ Отбрасываем\ всё\ за\ первым\ \(\backslash\)n\ включительно}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00062}00062\ \ \ \ \ \textcolor{keywordflow}{if}\ (!is\_video\_downloaded(video\_id))\ \{}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00063}00063\ \ \ \ \ \ \ \textcolor{comment}{//\ Видео\ не\ найдено\ в\ логе,\ создам\ его\ url}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00064}00064\ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ video\_url[BUF\_LEN];\ \textcolor{comment}{//\ Память\ под\ url}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00065}00065\ \ \ \ \ \ \ snprintf(video\_url,\ BUF\_LEN,\ \textcolor{stringliteral}{"{}https://www.youtube.com/watch?v=\%s"{}},\ video\_id);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00067}00067\ \ \ \ \ \ \ run\_yt\_dlp(video\_url,\ MODE2,\ DRAY\_DIR,\ FNAME);\ \textcolor{comment}{//\ Качаем}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00068}00068\ \ \ \ \ \ \ log\_video\_id(video\_id);\ \textcolor{comment}{//\ Логируем}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00069}00069\ \ \ \ \ \ \ sleep(5);\ \textcolor{comment}{//\ Спим\ (вместо\ задержки\ в\ опциях\ yt-\/dlp)}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00070}00070\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00071}00071\ \ \ \}}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00072}00072\ \ \ pclose(fp);}
\DoxyCodeLine{\Hypertarget{yt__dlp_8c_source_l00073}00073\ \}}

\end{DoxyCode}
